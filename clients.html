<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - QR Code Maintenance</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .header-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-back {
            background: #4facfe;
            color: white;
        }
        
        .btn-create {
            background: #10b981;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-view {
            background: #667eea;
            color: white;
        }
        
        .btn-edit {
            background: #10b981;
            color: white;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        
        /* Stili Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group small {
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1200px;">
        <div class="card">
            <h1>üë• Customer Management</h1>
            
            <div class="header-buttons">
                <a href="dashboard" class="btn-small btn-back">‚Üê Back to Dashboard</a>
                <button onclick="showCreateClientModal()" class="btn-small btn-create">‚ûï Create New Customer</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="search" placeholder="üîç Search by name, surname or phone...">
            </div>
            
            <div id="clients-container"></div>
            
            <footer>
                <p style="margin-bottom: 5px;">Powered by <strong>Guido Ballarini</strong></p>
                <p style="margin-bottom: 5px;">
                    <a href="https://github.com/Gheben/QRepair" target="_blank" style="margin: 0 8px; text-decoration: none;" title="GitHub Repository">‚ö´ GitHub</a>
                    <a href="https://buymeacoffee.com/guidoballau" target="_blank" style="margin: 0 8px; text-decoration: none; color: #FFDD00;" title="Buy Me a Coffee">‚òï Donazione</a>
                    <a href="https://www.paypal.com/donate/?hosted_button_id=8RF28JBPLYASN" target="_blank" style="margin: 0 8px; text-decoration: none; color: #0070BA;" title="PayPal">üí≥ PayPal</a>
                </p>
                <p style="margin-bottom: 0;">&copy; 2026 - All rights reserved</p>
            </footer>
        </div>
    </div>
    
    <!-- Modal Crea/Modifica Cliente -->
    <div id="client-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeClientModal()">&times;</span>
            <h2 id="modal-title">‚ûï New Customer</h2>
            <form id="clientForm">
                <input type="hidden" id="client-id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>First Name: <span style="color: red;">*</span></label>
                        <input type="text" id="client-nome" required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Last Name: <span style="color: red;">*</span></label>
                        <input type="text" id="client-cognome" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Mobile Number: <span style="color: red;">*</span></label>
                        <input type="tel" id="client-tel" required placeholder="+39 ...">
                        <small>Formato: +39 3331234567</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Lingua: <span style="color: red;">*</span></label>
                        <select id="client-lingua" required>
                            <option value="">Seleziona lingua...</option>
                            <option value="it">üáÆüáπ Italiano</option>
                            <option value="en">üá¨üáß English</option>
                            <option value="de">üá©üá™ Deutsch</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Email:</label>
                        <input type="email" id="client-email" placeholder="cliente@esempio.it">
                        <small>Campo opzionale</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>P.IVA:</label>
                        <input type="text" id="client-piva" placeholder="IT12345678901">
                        <small>Campo opzionale</small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Salva</button>
                    <button type="button" onclick="closeClientModal()" class="btn" style="flex: 1; background: #ccc;">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Manutenzioni Cliente -->
    <div id="maintenances-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeMaintenancesModal()">&times;</span>
            <h2 id="maintenances-title">üîß Manutenzioni Cliente</h2>
            <div id="maintenances-list"></div>
        </div>
    </div>
    
    <!-- Modal Aggiorna Manutenzione -->
    <div id="maintenance-update-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeMaintenanceModal()">&times;</span>
            <h2>üîÑ Aggiorna Manutenzione</h2>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cliente:</label>
                <input type="text" id="update-nome" readonly style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Modello:</label>
                <input type="text" id="update-modello" readonly style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">S/N:</label>
                <input type="text" id="update-serialnumber" readonly style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nuova Data Manutenzione:</label>
                <input type="date" id="update-data" required style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nuova Data Scadenza:</label>
                <input type="date" id="update-scadenza" required style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;">
                <small style="color: #666; font-size: 11px; display: block; margin-top: 3px;">‚ö†Ô∏è La scadenza deve essere successiva alla data di manutenzione</small>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveMaintenanceUpdate()" class="btn btn-primary" style="flex: 1;">‚úÖ Salva</button>
                <button onclick="closeMaintenanceModal()" class="btn" style="flex: 1; background: #ccc;">‚ùå Annulla</button>
            </div>
        </div>
    </div>
    
    <script>
        let allClients = [];
        let allMaintenances = [];
        let filteredClients = [];
        let currentClientId = null;
        let currentMaintenanceId = null;
        
        // Carica clienti e manutenzioni
        async function loadData() {
            try {
                const [clientsResponse, maintenancesResponse] = await Promise.all([
                    fetch('/api/clienti'),
                    fetch('/api/manutenzioni')
                ]);
                
                const clientsData = await clientsResponse.json();
                const maintenancesData = await maintenancesResponse.json();
                
                if (clientsData.success) {
                    allClients = clientsData.data;
                    filteredClients = allClients;
                }
                
                if (maintenancesData.success) {
                    allMaintenances = maintenancesData.data;
                }
                
                renderClients();
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                alert('‚ùå Error loading data');
            }
        }
        
        // Conta manutenzioni per cliente (per client_id)
        function countMaintenances(clientId) {
            return allMaintenances.filter(m => m.client_id === clientId).length;
        }
        
        // Ultima manutenzione per cliente
        function getLastMaintenance(clientId) {
            const clientMaintenances = allMaintenances.filter(m => m.client_id === clientId);
            if (clientMaintenances.length === 0) return null;
            
            return clientMaintenances.sort((a, b) => 
                new Date(b.data) - new Date(a.data)
            )[0];
        }
        
        // Render tabella clienti
        function renderClients() {
            const container = document.getElementById('clients-container');
            
            if (filteredClients.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No customers found</p>';
                return;
            }
            
            const langFlags = { it: 'it', en: 'gb', de: 'de' };
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Language</th>
                            <th>VAT Number</th>
                            <th>Maintenances</th>
                            <th>Last Maintenance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredClients.forEach(client => {
                const fullName = `${client.nome} ${client.cognome}`;
                const maintenanceCount = countMaintenances(client.id);
                const lastMaintenance = getLastMaintenance(client.id);
                const lastDate = lastMaintenance ? new Date(lastMaintenance.data).toLocaleDateString('it-IT') : '-';
                const flagClass = langFlags[client.lingua] || 'it';
                const flag = `<span class="fi fi-${flagClass}" style="font-size: 20px;"></span>`;
                
                html += `
                    <tr>
                        <td><strong>${fullName}</strong></td>
                        <td>${client.tel}</td>
                        <td>${client.email || '-'}</td>
                        <td>${flag}</td>
                        <td>${client.piva || '-'}</td>
                        <td style="text-align: center;">${maintenanceCount}</td>
                        <td>${lastDate}</td>
                        <td>
                            <div class="action-buttons">
                                ${maintenanceCount > 0 ? `<button onclick="viewMaintenances('${client.id}')" class="btn-action btn-view">üëÅÔ∏è Maintenances</button>` : ''}
                                <button onclick="editClient('${client.id}')" class="btn-action btn-edit">‚úèÔ∏è</button>
                                <button onclick="deleteClient('${client.id}', '${fullName}')" class="btn-action btn-delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Mostra modal crea cliente
        function showCreateClientModal() {
            document.getElementById('modal-title').textContent = '‚ûï New Customer';
            document.getElementById('client-id').value = '';
            document.getElementById('clientForm').reset();
            document.getElementById('client-modal').classList.add('active');
        }
        
        // Modifica cliente
        async function editClient(id) {
            console.log('editClient called with id:', id);
            console.log('allClients:', allClients);
            
            const client = allClients.find(c => c.id === id);
            console.log('Found client:', client);
            
            if (!client) {
                console.error('Client not found with id:', id);
                return;
            }
            
            document.getElementById('modal-title').textContent = '‚úèÔ∏è Edit Customer';
            document.getElementById('client-id').value = id;
            document.getElementById('client-nome').value = client.nome;
            document.getElementById('client-cognome').value = client.cognome;
            document.getElementById('client-tel').value = client.tel;
            document.getElementById('client-lingua').value = client.lingua;
            document.getElementById('client-email').value = client.email || '';
            document.getElementById('client-piva').value = client.piva || '';
            document.getElementById('client-modal').classList.add('active');
        }
        
        // Elimina cliente
        async function deleteClient(id, name) {
            console.log('deleteClient called with id:', id, 'name:', name);
            
            if (!confirm(`Are you sure you want to delete the customer "${name}"?\n\nWarning: associated maintenances will remain in the system.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/clienti/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Customer deleted!');
                    loadData();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Error during deletion');
            }
        }
        
        // Chiudi modal cliente
        function closeClientModal() {
            document.getElementById('client-modal').classList.remove('active');
        }
        
        // Salva cliente (crea o modifica)
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('client-id').value;
            const data = {
                nome: document.getElementById('client-nome').value.trim(),
                cognome: document.getElementById('client-cognome').value.trim(),
                tel: document.getElementById('client-tel').value.trim(),
                lingua: document.getElementById('client-lingua').value,
                email: document.getElementById('client-email').value.trim() || null,
                piva: document.getElementById('client-piva').value.trim() || null
            };
            
            try {
                const url = id 
                    ? `/api/clienti/${id}` 
                    : '/api/clienti';
                
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(id ? '‚úÖ Customer updated!' : '‚úÖ Customer created!');
                    closeClientModal();
                    loadData();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Error during save');
            }
        });
        
        // Visualizza manutenzioni cliente
        function viewMaintenances(clientId) {
            console.log('viewMaintenances called with clientId:', clientId);
            console.log('allClients:', allClients);
            
            const client = allClients.find(c => c.id === clientId);
            console.log('Found client:', client);
            
            if (!client) {
                console.error('Client not found with id:', clientId);
                return;
            }
            
            document.getElementById('maintenances-title').textContent = 
                `üîß Manutenzioni di ${client.nome} ${client.cognome}`;
            
            const clientMaintenances = allMaintenances.filter(m => m.client_id === clientId);
            console.log('Client maintenances:', clientMaintenances);
            
            const sorted = clientMaintenances.sort((a, b) => 
                new Date(b.data) - new Date(a.data)
            );
            
            let html = '<table style="margin-top: 20px;"><thead><tr><th>Date</th><th>Model</th><th>S/N</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>';
            
            sorted.forEach(m => {
                const dataFormat = new Date(m.data).toLocaleDateString('it-IT');
                
                let scadenzaFormat = '-';
                if (m.scadenza) {
                    if (m.scadenza.includes('/')) {
                        const parts = m.scadenza.split('/');
                        if (parts.length === 3) {
                            const scadenzaDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            if (!isNaN(scadenzaDate.getTime())) {
                                scadenzaFormat = scadenzaDate.toLocaleDateString('it-IT');
                            }
                        }
                    } else {
                        const scadenzaDate = new Date(m.scadenza);
                        if (!isNaN(scadenzaDate.getTime())) {
                            scadenzaFormat = scadenzaDate.toLocaleDateString('it-IT');
                        }
                    }
                }
                
                html += `
                    <tr>
                        <td>${dataFormat}</td>
                        <td>${m.modello || '-'}</td>
                        <td>${m.serialNumber || '-'}</td>
                        <td>${scadenzaFormat}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="showMaintenanceUpdateModal('${m.id}')" class="btn-action btn-edit">üîÑ Manutenzione Eseguita</button>
                                <a href="/info?id=${m.id}" target="_blank" class="btn-action btn-view">üëÅÔ∏è Vedi</a>
                                <button onclick="deleteMaintenance('${m.id}', '${m.modello || 'Manutenzione'}')" class="btn-action btn-delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            document.getElementById('maintenances-list').innerHTML = html;
            document.getElementById('maintenances-modal').classList.add('active');
        }
        
        function closeMaintenancesModal() {
            document.getElementById('maintenances-modal').classList.remove('active');
        }
        
        function showMaintenanceUpdateModal(id) {
            currentMaintenanceId = id;
            const record = allMaintenances.find(r => r.id === id);
            
            if (!record) return;
            
            document.getElementById('update-nome').value = record.nome || '';
            document.getElementById('update-modello').value = record.modello || '';
            document.getElementById('update-serialnumber').value = record.serialNumber || '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('update-data').value = today;
            
            const oneYearLater = new Date();
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
            document.getElementById('update-scadenza').value = oneYearLater.toISOString().split('T')[0];
            
            document.getElementById('maintenance-update-modal').classList.add('active');
        }
        
        function closeMaintenanceModal() {
            document.getElementById('maintenance-update-modal').classList.remove('active');
            currentMaintenanceId = null;
        }
        
        async function saveMaintenanceUpdate() {
            if (!currentMaintenanceId) return;
            
            const data = document.getElementById('update-data').value;
            const scadenza = document.getElementById('update-scadenza').value;
            
            if (!data || !scadenza) {
                alert('‚ö†Ô∏è Fill in all required fields');
                return;
            }
            
            if (new Date(newScadenza) <= new Date(newData)) {
                alert('‚ö†Ô∏è The due date must be after the maintenance date');
                return;
            }
            
            // Converti la scadenza in formato DD/MM/YYYY
            const scadenzaDate = new Date(scadenza);
            const scadenzaFormatted = `${String(scadenzaDate.getDate()).padStart(2, '0')}/${String(scadenzaDate.getMonth() + 1).padStart(2, '0')}/${scadenzaDate.getFullYear()}`;
            
            try {
                const record = allMaintenances.find(r => r.id === currentMaintenanceId);
                
                const response = await fetch(`/api/manutenzioni/${currentMaintenanceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...record,
                        data,
                        scadenza: scadenzaFormatted
                    })
                });
                
                if (response.ok) {
                    closeMaintenanceModal();
                    closeMaintenancesModal();
                    loadData();
                    alert('‚úÖ Maintenance updated!');
                } else {
                    alert('‚ùå Error during update');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Error during update');
            }
        }
        
        // Elimina manutenzione
        async function deleteMaintenance(id, modello) {
            if (!confirm(`Are you sure you want to delete the maintenance "${modello}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/manutenzioni/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('‚úÖ Maintenance deleted!');
                    closeMaintenancesModal();
                    await loadData();
                } else {
                    alert('‚ùå Error during deletion');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Error during deletion');
            }
        }
        
        // Ricerca clienti
        document.getElementById('search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (query === '') {
                filteredClients = allClients;
            } else {
                filteredClients = allClients.filter(c => 
                    c.nome.toLowerCase().includes(query) || 
                    c.cognome.toLowerCase().includes(query) ||
                    c.tel.includes(query) ||
                    (c.email && c.email.toLowerCase().includes(query))
                );
            }
            
            renderClients();
        });
        
        // Carica i dati all'avvio
        loadData();
    </script>
</body>
</html>
